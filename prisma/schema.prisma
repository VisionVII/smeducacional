// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum ActivityType {
  QUIZ
  ASSIGNMENT
  EXAM
}

enum NotificationType {
  COURSE
  ACTIVITY
  GRADE
  SYSTEM
  MESSAGE
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  role          UserRole  @default(STUDENT)
  avatar        String?
  phone         String?
  bio           String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relações
  enrollments      Enrollment[]
  progress         Progress[]
  certificates     Certificate[]
  createdCourses   Course[]        @relation("CourseCreator")
  activities       Activity[]      @relation("ActivityCreator")
  submissions      Submission[]
  grades           Grade[]
  gradedActivities Grade[]         @relation("GradedBy")
  notifications    Notification[]
  sentMessages     Message[]       @relation("MessageSender")
  receivedMessages Message[]       @relation("MessageReceiver")
  supportTickets   SupportTicket[]
  activityLogs     ActivityLog[]

  @@map("users")
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  courses Course[]

  @@map("categories")
}

model Course {
  id             String   @id @default(cuid())
  title          String
  slug           String   @unique
  description    String
  thumbnail      String?
  duration       Int? // em minutos
  level          String? // Iniciante, Intermediário, Avançado
  price          Float    @default(0)
  isPaid         Boolean  @default(false)
  isPublished    Boolean  @default(false)
  requirements   String?
  whatYouLearn   String?
  categoryId     String
  instructorId   String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relações
  category     Category       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  instructor   User           @relation("CourseCreator", fields: [instructorId], references: [id], onDelete: Cascade)
  modules      Module[]
  enrollments  Enrollment[]
  certificates Certificate[]

  @@index([categoryId])
  @@index([instructorId])
  @@index([slug])
  @@map("courses")
}

model Module {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int
  courseId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId])
  @@map("modules")
}

model Lesson {
  id          String   @id @default(cuid())
  title       String
  description String?
  content     String? // Texto ou embed de vídeo
  videoUrl    String?
  duration    Int? // em segundos
  order       Int
  isFree      Boolean  @default(false)
  moduleId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações
  module    Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  materials Material[]
  progress  Progress[]

  @@index([moduleId])
  @@map("lessons")
}

model Material {
  id        String   @id @default(cuid())
  title     String
  type      String // PDF, DOC, IMAGE, LINK
  url       String
  size      Int? // em bytes
  lessonId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@map("materials")
}

model Enrollment {
  id         String           @id @default(cuid())
  status     EnrollmentStatus @default(ACTIVE)
  progress   Float            @default(0) // 0-100
  studentId  String
  courseId   String
  enrolledAt DateTime         @default(now())
  completedAt DateTime?
  updatedAt  DateTime         @updatedAt

  // Relações
  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
  @@map("enrollments")
}

model Progress {
  id           String   @id @default(cuid())
  studentId    String
  lessonId     String
  isCompleted  Boolean  @default(false)
  watchTime    Int      @default(0) // em segundos
  lastPosition Int      @default(0) // última posição do vídeo em segundos
  completedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relações
  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lesson  Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([studentId, lessonId])
  @@index([studentId])
  @@index([lessonId])
  @@map("progress")
}

model Certificate {
  id           String   @id @default(cuid())
  certificateNumber String   @unique
  studentId    String
  courseId     String
  issuedAt     DateTime @default(now())
  validUntil   DateTime?

  // Relações
  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([courseId])
  @@map("certificates")
}

model Activity {
  id          String       @id @default(cuid())
  title       String
  description String
  type        ActivityType
  dueDate     DateTime?
  maxScore    Float        @default(100)
  moduleId    String?
  createdById String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relações
  createdBy   User         @relation("ActivityCreator", fields: [createdById], references: [id], onDelete: Cascade)
  submissions Submission[]
  grades      Grade[]

  @@index([createdById])
  @@map("activities")
}

model Submission {
  id         String   @id @default(cuid())
  content    String
  fileUrl    String?
  studentId  String
  activityId String
  submittedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relações
  student  User  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  grade    Grade?

  @@index([studentId])
  @@index([activityId])
  @@map("submissions")
}

model Grade {
  id           String   @id @default(cuid())
  score        Float
  feedback     String?
  submissionId String   @unique
  studentId    String
  activityId   String
  gradedById   String
  gradedAt     DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relações
  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  student    User    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  activity   Activity   @relation(fields: [activityId], references: [id], onDelete: Cascade)
  gradedBy   User       @relation("GradedBy", fields: [gradedById], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([activityId])
  @@index([gradedById])
  @@map("grades")
}

model Notification {
  id        String           @id @default(cuid())
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  userId    String
  createdAt DateTime         @default(now())

  // Relações
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}

model Message {
  id         String   @id @default(cuid())
  subject    String
  content    String
  isRead     Boolean  @default(false)
  senderId   String
  receiverId String
  createdAt  DateTime @default(now())

  // Relações
  sender   User @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@map("messages")
}

model SupportTicket {
  id        String   @id @default(cuid())
  subject   String
  message   String
  status    String   @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  priority  String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("support_tickets")
}

model ActivityLog {
  id        String   @id @default(cuid())
  action    String
  details   String?
  ipAddress String?
  userId    String
  createdAt DateTime @default(now())

  // Relações
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("activity_logs")
}
